
<!DOCTYPE html>
<html lang="en">
<head>
        <!-- tsParticles network animation background -->
        <script src="https://cdn.jsdelivr.net/npm/tsparticles@3.1.0/tsparticles.bundle.min.js"></script>
        <script src="{{ url_for('static', filename='particles-config.js') }}"></script>
    <meta charset="UTF-8">
    <title>Malware/Goodware Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
            <button id="theme-toggle" class="btn" style="position:fixed;top:18px;left:18px;z-index:20;font-weight:bold;background:#232526;color:#fff;border:2px solid #232526;transition:background 0.3s,color 0.3s;">ðŸŒ™ Dark</button>
        <div id="tsparticles" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-2;"></div>
        <img src="{{ url_for('static', filename='nn-left.svg') }}" alt="Neural Net Left" style="position:fixed;left:0;top:0;height:100vh;width:auto;z-index:-1;pointer-events:none;"/>
        <img src="{{ url_for('static', filename='nn-right.svg') }}" alt="Neural Net Right" style="position:fixed;right:0;top:0;height:100vh;width:auto;z-index:-1;pointer-events:none;"/>

        <!-- About/Info Modal Button -->
    <div class="container">
        <h1 class="mb-4">Malware/Goodware Prediction</h1>
        <form method="POST" class="row g-3 mb-4">
            {% for f in features %}
                <div class="col-md-4">
                    <label class="form-label">{{ f }}</label>
                    <input type="text" class="form-control" name="{{ f }}" value="{{ demo_row[f] }}">
                </div>
            {% endfor %}
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Predict</button>
            </div>
        </form>
        {% if prediction %}
            <div class="alert alert-info">
                <h4>Prediction: {{ prediction }}</h4>
                {% if confidence is not none %}
                    <div>Model Confidence: <b>{{ '%.2f' % (confidence * 100) }}%</b></div>
                {% endif %}
            </div>
        {% endif %}
        {% if feature_importance %}
            <div class="card mt-4" style="background:#232526;color:#ffb347;">
                <h5>Top Feature Importances</h5>
                <div style="max-width:420px;">
                    <svg width="100%" height="{{ feature_importance|length * 32 }}">
                        {% for f, imp in feature_importance %}
                        <g transform="translate(0,{{ loop.index0 * 32 }})">
                            <text x="0" y="20" font-size="15">{{ f }}</text>
                            <rect x="120" y="8" height="16" width="{{ 180 * (imp|abs) / (feature_importance[0][1]|abs if feature_importance[0][1] else 1) }}" fill="#ffb347"/>
                            <text x="{{ 120 + 180 * (imp|abs) / (feature_importance[0][1]|abs if feature_importance[0][1] else 1) + 8 }}" y="20" font-size="13">{{ '%.3f' % imp }}</text>
                        </g>
                        {% endfor %}
                    </svg>
                </div>
            </div>
        {% endif %}
        <hr>
        <h2 class="mb-3">Batch Prediction</h2>
        <form id="batch-form" action="/predict_batch" method="post" enctype="multipart/form-data" class="mb-3">
            <input type="file" class="form-control" name="file" accept=".csv">
            <button type="submit" class="btn btn-success mt-2">Upload and Predict</button>
        </form>
        <div id="batch-spinner" style="display:none;text-align:center;margin:20px 0;">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="batch-error" class="alert alert-danger" style="display:none;"></div>
        <button id="download-csv" class="btn mb-3" style="display:none;background:#232526;color:#fff;border:2px solid #232526;font-weight:bold;">Download Results (CSV)</button>
        <div class="table-responsive" id="batch-results"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Dark/Light mode toggle
    const themeToggle = document.getElementById('theme-toggle');
    let darkMode = true;
    function setTheme(dark) {
        document.body.style.background = dark ? 'linear-gradient(135deg, #232526 0%, #414345 100%)' : 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
        document.body.style.color = dark ? '#f5f5f5' : '#232526';
        document.querySelectorAll('.container, .card, .modal-content').forEach(el => {
            el.style.background = dark ? 'rgba(34,34,34,0.95)' : '#fff';
            el.style.color = dark ? '#ffb347' : '#232526';
        });
        document.querySelectorAll('.alert-info').forEach(el => {
            el.style.background = dark ? '#232526' : '#e9ecef';
            el.style.color = dark ? '#ffb347' : '#232526';
        });
        document.querySelectorAll('.alert-danger').forEach(el => {
            el.style.background = dark ? '#2c2c2c' : '#f8d7da';
            el.style.color = dark ? '#ffb347' : '#721c24';
        });
        document.querySelectorAll('.btn').forEach(el => {
            if (el.id === 'theme-toggle') {
                el.style.background = dark ? '#232526' : '#fff';
                el.style.color = dark ? '#fff' : '#232526';
                el.style.border = dark ? '2px solid #232526' : '2px solid #fff';
                el.innerHTML = dark ? 'ðŸŒ™ Dark' : 'â˜€ï¸ Light';
            } else if (el.classList.contains('btn-info')) {
                el.style.background = dark ? '#343a40' : '#0dcaf0';
            } else if (el.classList.contains('btn-outline-light')) {
                el.style.background = dark ? '#232526' : '#fff';
            }
        });
        document.querySelectorAll('.modal-content').forEach(el => {
            el.style.background = dark ? '#232526' : '#fff';
            el.style.color = dark ? '#ffb347' : '#232526';
        });
        document.querySelectorAll('footer').forEach(el => {
            el.style.background = dark ? 'rgba(34,34,34,0.92)' : '#e9ecef';
            el.style.color = dark ? '#ffb347' : '#232526';
        });
    }
    themeToggle.onclick = function() {
        darkMode = !darkMode;
        setTheme(darkMode);
    };
    setTheme(true);
    </script>
    <script>
    const batchForm = document.getElementById('batch-form');
    const batchSpinner = document.getElementById('batch-spinner');
    const batchError = document.getElementById('batch-error');
    const batchResults = document.getElementById('batch-results');
    const downloadBtn = document.getElementById('download-csv');
    let lastBatchData = null;

    batchForm.onsubmit = async function(e) {
        e.preventDefault();
        batchSpinner.style.display = '';
        batchError.style.display = 'none';
        batchResults.innerHTML = '';
        downloadBtn.style.display = 'none';
        const formData = new FormData(this);
        try {
            const response = await fetch('/predict_batch', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) throw new Error('Server error: ' + response.status);
            const data = await response.json();
            lastBatchData = data;
            let html = '<h3>Batch Results</h3>';
            html += '<table class="table table-bordered table-striped"><thead><tr>';
            for (let key in data.results[0]) html += `<th>${key}</th>`;
            html += '</tr></thead><tbody>';
            for (let row of data.results) {
                html += '<tr>';
                for (let key in row) html += `<td>${row[key]}</td>`;
                html += '</tr>';
            }
            html += '</tbody></table>';
            if (data.metrics) {
                html += `<div class="metrics-box"><h4>Metrics</h4><pre>${JSON.stringify(data.metrics, null, 2)}</pre></div>`;
            }
            batchResults.innerHTML = html;
            downloadBtn.style.display = '';
        } catch (err) {
            batchError.textContent = 'Error: ' + (err.message || 'An error occurred. Please check your file and try again.');
            batchError.style.display = '';
        } finally {
            batchSpinner.style.display = 'none';
        }
    };

    downloadBtn.onclick = function() {
        if (!lastBatchData || !lastBatchData.results) return;
        const rows = lastBatchData.results;
        const keys = Object.keys(rows[0]);
        let csv = keys.join(',') + '\n';
        for (const row of rows) {
            csv += keys.map(k => '"' + String(row[k]).replace(/"/g, '""') + '"').join(',') + '\n';
        }
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'batch_results.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };
    </script>
    <footer style="width:100vw;text-align:center;padding:18px 0 10px 0;background:rgba(34,34,34,0.92);color:#ffb347;position:fixed;bottom:0;left:0;z-index:10;font-size:1rem;letter-spacing:0.5px;">
        &copy; 2026 Malware/Goodware ML Project &mdash; Qis QSBT project &mdash; Powered by Flask &amp; Machine Learning
    </footer>
</body>
</html>
